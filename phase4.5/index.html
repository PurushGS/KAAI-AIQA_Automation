<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIQA Phase 4.5 - RAG Service</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      text-align: center;
    }

    h1 {
      font-size: 36px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
      font-size: 14px;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .results {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-item {
      background: white;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .result-title {
      font-weight: bold;
      color: #333;
    }

    .relevance-score {
      background: #667eea;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
    }

    .result-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .result-summary {
      font-size: 13px;
      color: #555;
      line-height: 1.5;
    }

    .ai-answer {
      background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .ai-answer-label {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      border-left: 4px solid #c33;
    }

    .success {
      background: #efe;
      color: #3c3;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      border-left: 4px solid #3c3;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 5px;
      margin-bottom: 5px;
    }

    .badge-critical { background: #ff4444; color: white; }
    .badge-high { background: #ff8800; color: white; }
    .badge-medium { background: #ffbb33; color: white; }
    .badge-low { background: #00c851; color: white; }

    .test-list {
      margin-top: 10px;
    }

    .test-item {
      background: white;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      border-left: 3px solid #667eea;
      font-size: 13px;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üß† AIQA RAG Service</h1>
      <p class="subtitle">Intelligent Knowledge Base powered by Vector Search</p>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-value" id="totalTests">-</div>
        <div class="stat-label">Total Tests</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="successRate">-</div>
        <div class="stat-label">Success Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="uniqueUrls">-</div>
        <div class="stat-label">Unique URLs</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgDuration">-</div>
        <div class="stat-label">Avg Duration</div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Query Knowledge Base -->
      <div class="card">
        <div class="card-title">üîç Query Knowledge Base</div>
        
        <form id="queryForm">
          <div class="form-group">
            <label>Natural Language Query</label>
            <textarea id="queryText" placeholder="e.g., Show me all failed login tests&#10;What tests were run on app.example.com?&#10;Find file upload tests"></textarea>
          </div>

          <div class="form-group">
            <label>Filter by Success</label>
            <select id="queryFilter">
              <option value="">All tests</option>
              <option value="true">Successful only</option>
              <option value="false">Failed only</option>
            </select>
          </div>

          <button type="submit">Query RAG üöÄ</button>
        </form>

        <div id="queryResults"></div>
      </div>

      <!-- Store Test Execution -->
      <div class="card">
        <div class="card-title">üíæ Store Test Execution</div>
        
        <form id="storeForm">
          <div class="form-group">
            <label>Test ID</label>
            <input type="text" id="testId" placeholder="test_001" required>
          </div>

          <div class="form-group">
            <label>Test Name</label>
            <input type="text" id="testName" placeholder="Login flow test" required>
          </div>

          <div class="form-group">
            <label>URL Tested</label>
            <input type="url" id="testUrl" placeholder="https://app.example.com" required>
          </div>

          <div class="form-group">
            <label>Test Steps (JSON)</label>
            <textarea id="testSteps" placeholder='[{"action": "navigate", "target": "https://..."}]'></textarea>
          </div>

          <div class="form-group">
            <label>Results (JSON)</label>
            <textarea id="testResults" placeholder='{"passed": 5, "failed": 0, "duration": 2500}'></textarea>
          </div>

          <button type="submit">Store in RAG üíæ</button>
        </form>

        <div id="storeResults"></div>
      </div>

      <!-- Git Analysis -->
      <div class="card">
        <div class="card-title">üîß Git Change Analysis</div>
        
        <form id="gitForm">
          <div class="form-group">
            <label>Changed Files (one per line)</label>
            <textarea id="changedFiles" placeholder="backend/api/auth.js&#10;frontend/components/Login.tsx&#10;tests/login.test.js"></textarea>
          </div>

          <div class="form-group">
            <label>Commit Message (optional)</label>
            <input type="text" id="commitMessage" placeholder="Fix authentication bug">
          </div>

          <button type="submit">Analyze Impact üîç</button>
        </form>

        <div id="gitResults"></div>
      </div>

      <!-- Similar Tests -->
      <div class="card">
        <div class="card-title">üîó Find Similar Tests</div>
        
        <form id="similarForm">
          <div class="form-group">
            <label>Test ID</label>
            <input type="text" id="similarTestId" placeholder="test_001" required>
          </div>

          <div class="form-group">
            <label>Number of Results</label>
            <input type="number" id="similarLimit" value="5" min="1" max="20">
          </div>

          <button type="submit">Find Similar Tests üîó</button>
        </form>

        <div id="similarResults"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3005';

    // Load stats on page load
    loadStats();

    // Query Form
    document.getElementById('queryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const query = document.getElementById('queryText').value;
      const filter = document.getElementById('queryFilter').value;
      const resultsDiv = document.getElementById('queryResults');
      
      if (!query.trim()) return;
      
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Querying knowledge base...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/api/rag/query`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: query,
            filters: filter ? { success: filter === 'true' } : {},
            limit: 5
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          let html = '';
          
          // AI Answer
          if (data.answer) {
            html += `
              <div class="ai-answer">
                <div class="ai-answer-label">ü§ñ AI Answer</div>
                <div>${data.answer}</div>
              </div>
            `;
          }
          
          // Results
          html += '<div class="results">';
          if (data.results.length === 0) {
            html += '<p>No results found.</p>';
          } else {
            data.results.forEach(result => {
              html += `
                <div class="result-item">
                  <div class="result-header">
                    <div class="result-title">${result.testName}</div>
                    <span class="relevance-score">${(result.relevanceScore * 100).toFixed(0)}% match</span>
                  </div>
                  <div class="result-meta">
                    <code>${result.testId}</code> ‚Ä¢ ${result.url} ‚Ä¢ ${result.timestamp.split('T')[0]}
                  </div>
                  <div class="result-meta">
                    ‚úÖ ${result.passed} passed ‚Ä¢ ‚ùå ${result.failed} failed ‚Ä¢ ‚è±Ô∏è ${result.duration}ms
                  </div>
                  <div class="result-summary">${result.summary}</div>
                </div>
              `;
            });
          }
          html += '</div>';
          
          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Failed to query: ${error.message}</div>`;
      }
    });

    // Store Form
    document.getElementById('storeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const resultsDiv = document.getElementById('storeResults');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Storing in RAG...</div>';
      
      try {
        const testExecution = {
          testId: document.getElementById('testId').value,
          testName: document.getElementById('testName').value,
          url: document.getElementById('testUrl').value,
          steps: JSON.parse(document.getElementById('testSteps').value || '[]'),
          results: JSON.parse(document.getElementById('testResults').value || '{}'),
          metadata: {
            timestamp: new Date().toISOString(),
            browser: 'chromium',
            testType: 'manual'
          }
        };
        
        const response = await fetch(`${API_BASE}/api/rag/store`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testExecution)
        });
        
        const data = await response.json();
        
        if (data.success) {
          resultsDiv.innerHTML = `
            <div class="success">
              ‚úÖ Test stored successfully!<br>
              Embedding ID: <code>${data.embeddingId}</code>
            </div>
          `;
          loadStats(); // Refresh stats
        } else {
          resultsDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Failed to store: ${error.message}</div>`;
      }
    });

    // Git Form
    document.getElementById('gitForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const filesText = document.getElementById('changedFiles').value;
      const changedFiles = filesText.split('\n').filter(f => f.trim());
      const resultsDiv = document.getElementById('gitResults');
      
      if (changedFiles.length === 0) return;
      
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing git changes...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/api/rag/git-analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            changedFiles: changedFiles,
            message: document.getElementById('commitMessage').value,
            diff: 'Sample diff for testing'
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          let html = '<div class="results">';
          
          html += `
            <div style="margin-bottom: 15px;">
              <strong>Risk Level:</strong> <span class="badge badge-${data.riskLevel}">${data.riskLevel.toUpperCase()}</span>
            </div>
          `;
          
          if (data.affectedFeatures && data.affectedFeatures.length > 0) {
            html += `<div style="margin-bottom: 10px;"><strong>Affected Features:</strong></div>`;
            data.affectedFeatures.forEach(feature => {
              html += `<span class="badge" style="background: #e0e0e0; color: #333;">${feature}</span>`;
            });
          }
          
          if (data.recommendedTests && data.recommendedTests.length > 0) {
            html += `<div style="margin-top: 15px; margin-bottom: 10px;"><strong>Recommended Tests:</strong></div>`;
            html += '<div class="test-list">';
            data.recommendedTests.forEach(test => {
              html += `
                <div class="test-item">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div><strong>${test.testId}</strong></div>
                    <span class="badge badge-${test.priority}">${test.priority}</span>
                  </div>
                  <div style="font-size: 12px; color: #666; margin-top: 5px;">${test.reason}</div>
                </div>
              `;
            });
            html += '</div>';
          }
          
          if (data.recommendation) {
            html += `<div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px;"><strong>Recommendation:</strong> ${data.recommendation}</div>`;
          }
          
          html += '</div>';
          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Failed to analyze: ${error.message}</div>`;
      }
    });

    // Similar Form
    document.getElementById('similarForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const testId = document.getElementById('similarTestId').value;
      const limit = document.getElementById('similarLimit').value;
      const resultsDiv = document.getElementById('similarResults');
      
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Finding similar tests...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/api/rag/similar/${testId}?limit=${limit}`);
        const data = await response.json();
        
        if (data.success) {
          let html = '<div class="results">';
          
          html += `<div style="margin-bottom: 15px;"><strong>Original Test:</strong> ${data.originalTest.testName}</div>`;
          
          if (data.similarTests.length === 0) {
            html += '<p>No similar tests found.</p>';
          } else {
            data.similarTests.forEach(test => {
              html += `
                <div class="result-item">
                  <div class="result-header">
                    <div class="result-title">${test.testName}</div>
                    <span class="relevance-score">${(test.relevanceScore * 100).toFixed(0)}% similar</span>
                  </div>
                  <div class="result-meta">
                    <code>${test.testId}</code> ‚Ä¢ ${test.url}
                  </div>
                </div>
              `;
            });
          }
          
          html += '</div>';
          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Failed to find: ${error.message}</div>`;
      }
    });

    // Load Stats
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/api/rag/stats`);
        const data = await response.json();
        
        if (data.success) {
          const stats = data.stats;
          document.getElementById('totalTests').textContent = stats.totalTests || 0;
          document.getElementById('successRate').textContent = ((stats.averageSuccessRate || 0) * 100).toFixed(0) + '%';
          document.getElementById('uniqueUrls').textContent = stats.uniqueUrls || 0;
          document.getElementById('avgDuration').textContent = Math.round(stats.averageDuration || 0) + 'ms';
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }
  </script>
</body>
</html>

